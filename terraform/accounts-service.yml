#file: noinspection MaybeTerraformTemplateInspection
openapi: 3.0.1
info:
  version: "3.0"
  title: Compute Resources API
  description: |
    This is the serverless Compute Resources API
  termsOfService: https://docs.pennsieve.io/page/pennsieve-terms-of-use
  contact:
    name: Pennsieve Support
    email: support@pennsieve.net
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
servers:
  - url: https://api2.pennsieve.io/compute/resources
    description: Production server
  - url: https://api2.pennsieve.net/compute/resources
    description: Development server
externalDocs:
  description: Find more info here
  url: https://docs.pennsieve.io
tags:
  - name: Accounts Service
    description: Management of external accounts that can provide compute and/or storage capabilities.
    externalDocs:
      url: https://docs.pennsieve.io/reference
  - name: Compute Nodes
    description: Management of compute nodes for running analytical workflows on the Pennsieve platform.
components:
  x-amazon-apigateway-integrations:
    account-service:
      type: aws_proxy
      uri: ${account_service_lambda_arn}
      httpMethod: POST
      passthroughBehavior: when_no_match
      contentHandling: CONVERT_TO_TEXT
      payloadFormatVersion: 2.0
  securitySchemes:
    token_dataset_auth:
      type: "apiKey"
      name: "Unused"
      in: "header"
      x-amazon-apigateway-authorizer:
        identitySource: "$request.header.Authorization,$request.querystring.dataset_id"
        authorizerUri: ${authorize_lambda_invoke_uri}
        authorizerPayloadFormatVersion: "2.0"
        authorizerResultTtlInSeconds: 300
        type: "request"
        enableSimpleResponses: true
        authorizerCredentials: ${gateway_authorizer_role}
    token_auth:
      type: "apiKey"
      name: "Authorization"
      in: "header"
      x-amazon-apigateway-authorizer:
        identitySource: "$request.header.Authorization"
        authorizerUri: ${authorize_lambda_invoke_uri}
        authorizerPayloadFormatVersion: "2.0"
        authorizerResultTtlInSeconds: 300
        type: "request"
        enableSimpleResponses: true
        authorizerCredentials: ${gateway_authorizer_role}
    token_workspace_auth:
      type: "apiKey"
      name: "Authorization"
      in: "header"
      x-amazon-apigateway-authorizer:
        identitySource: "$request.header.Authorization,$request.querystring.organization_id"
        authorizerUri: ${authorize_lambda_invoke_uri}
        authorizerPayloadFormatVersion: "2.0"
        authorizerResultTtlInSeconds: 300
        type: "request"
        enableSimpleResponses: true
        authorizerCredentials: ${gateway_authorizer_role}
  schemas:
    accountRequest:
      type: object
      properties:
        accountId:
          type: string
          description: the registered accountId
        accountType:
          type: string
          description: the type of account
        roleName:
          type: string
          description: the name of the created role
        externalId:
          type: string
          description: a unique identifier for the role
        name:
          type: string
          description: optional name for the account
        description:
          type: string
          description: optional description for the account
    pennsieveAccountsGetResponse:
      type: object
      properties:
        accountId:
          type: string
          description: the accountId of the Pennsieve Account
        accountType:
          type: string
          description: the account type of Pennsieve Account
    postAccountsResponse:
      type: object
      properties:
        uuid:
          type: string
          description: the uuid of the created compute resource account
    accountsGetResponse:
      type: object
      properties:
        uuid:
          type: string
          description: the uuid of the compute resource account
        accountId:
          type: string
          description: the accountId of the compute resource account
        accountType:
          type: string
          description: the account type of compute resource account
        roleName:
          type: string
          description: the name of the role in the compute resource account
        externalId:
          type: string
          description: the generated externalId for compute resource account
        organizationId:
          type: string
          description: the organization of the role creator for the compute resource account
        userId:
          type: string
          description: the user that created the role for the compute resource account
        name:
          type: string
          description: the name of the account
        description:
          type: string
          description: the description of the account
        status:
          type: string
          enum: ["Enabled", "Paused"]
          description: the status of the account
    workspaceEnablementRequest:
      type: object
      properties:
        isPublic:
          type: boolean
          description: if true, workspace managers can create compute nodes on this account; if false, only the account owner can
    workspaceEnablementResponse:
      type: object
      properties:
        uuid:
          type: string
          description: the uuid of the compute resource account
        workspaceId:
          type: string
          description: the workspace ID
        isPublic:
          type: boolean
          description: if true, workspace managers can create compute nodes on this account; if false, only the account owner can
        createdAt:
          type: string
          format: date-time
          description: timestamp when the enablement was created
    computeNodeRequest:
      type: object
      required:
        - name
        - account
      properties:
        name:
          type: string
          description: Name of the compute node
        description:
          type: string
          description: Description of the compute node
        account:
          type: object
          required:
            - uuid
          properties:
            uuid:
              type: string
              description: UUID of the compute resource account to use
        workflowManagerTag:
          type: string
          description: Docker tag for the workflow manager
          default: latest
    computeNodeResponse:
      type: object
      properties:
        uuid:
          type: string
          description: UUID of the compute node
        name:
          type: string
          description: Name of the compute node
        description:
          type: string
          description: Description of the compute node
        computeNodeGatewayUrl:
          type: string
          description: Gateway URL for the compute node
        efsId:
          type: string
          description: EFS ID for the compute node storage
        queueUrl:
          type: string
          description: SQS Queue URL for the compute node
        account:
          type: object
          properties:
            uuid:
              type: string
              description: UUID of the account
            accountId:
              type: string
              description: AWS Account ID
            accountType:
              type: string
              description: Type of account (e.g., aws)
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        organizationId:
          type: string
          description: Organization ID (workspace) this node belongs to. Empty for organization-independent nodes.
        userId:
          type: string
          description: User ID who created this node
        identifier:
          type: string
          description: Unique identifier for the compute node
        workflowManagerTag:
          type: string
          description: Docker tag for the workflow manager
        accessScope:
          type: string
          enum: ["private", "workspace", "shared"]
          description: Current access scope level of the compute node
        status:
          type: string
          enum: ["Enabled", "Paused"]
          description: Current status of the compute node
    computeNodeUpdateRequest:
      type: object
      properties:
        workflowManagerTag:
          type: string
          description: Docker tag for the workflow manager
        workflowManagerCpu:
          type: integer
          description: CPU units for the workflow manager
        workflowManagerMemory:
          type: integer
          description: Memory (MB) for the workflow manager
        authorizationType:
          type: string
          enum: ["NONE", "AWS_IAM"]
          description: Authorization type for the API Gateway
    computeNodePermissionsRequest:
      type: object
      required:
        - accessScope
      properties:
        accessScope:
          type: string
          enum: ["private", "workspace", "shared"]
          description: |
            Access scope level for the compute node:
            - private: Only the owner can access
            - workspace: All workspace members can access
            - shared: Specific users and/or teams can access
        sharedWithUsers:
          type: array
          items:
            type: string
          description: List of user IDs to share with (only used when accessScope is "shared")
        sharedWithTeams:
          type: array
          items:
            type: string
          description: List of team IDs to share with (only used when accessScope is "shared")
    computeNodePermissionsResponse:
      type: object
      properties:
        nodeUuid:
          type: string
          description: UUID of the compute node
        accessScope:
          type: string
          enum: ["private", "workspace", "shared"]
          description: Current access scope level
        owner:
          type: string
          description: User ID of the node owner
        sharedWithUsers:
          type: array
          items:
            type: string
          description: List of user IDs the node is shared with
        sharedWithTeams:
          type: array
          items:
            type: string
          description: List of team IDs the node is shared with
        organizationId:
          type: string
          description: Organization ID for workspace access scope
    computeNodeAccessScopeRequest:
      type: object
      required:
        - accessScope
      properties:
        accessScope:
          type: string
          enum: ["private", "workspace", "shared"]
          description: |
            Access scope level for the compute node:
            - private: Only the owner can access
            - workspace: All workspace members can access
            - shared: Specific users and/or teams can access (existing shared access remains)
    grantUserAccessRequest:
      type: object
      required:
        - userId
      properties:
        userId:
          type: string
          description: ID of the user to grant access to
    grantTeamAccessRequest:
      type: object
      required:
        - teamId
      properties:
        teamId:
          type: string
          description: ID of the team to grant access to
    permissionActionResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
        nodeUuid:
          type: string
          description: UUID of the compute node
        action:
          type: string
          description: Action performed (granted/revoked)
        entityType:
          type: string
          enum: ["user", "team"]
          description: Type of entity the action was performed on
        entityId:
          type: string
          description: ID of the entity the action was performed on
  responses:
    Unauthorized:
      description: Incorrect authentication or user has incorrect permissions.
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
    Error:
      description: Server Error
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
paths:
  /pennsieve-accounts/{accountType}:
    get:
      summary: Get Pennsieve Accounts
      description: |
        Gets Pennsieve Accounts by accountType
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: getPennsieveAccounts
      security:
        - token_auth: [ ]
      tags:
        - Account
      parameters:
        - in: path
          name: accountType
          required: true
          schema:
            type: string
          description: The Pennsieve account type.
      responses:
        '200':
          description: The requested account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/pennsieveAccountsGetResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /accounts/{uuid}/workspaces:
    post:
      summary: Enable a workspace for an account
      description: |
        Enables a workspace for a specific compute resource account. The isPublic flag determines
        who can create compute nodes on this account: if true, workspace managers can create nodes;
        if false, only the account owner can create nodes
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: postAccountWorkspaceEnablement
      security:
        - token_workspace_auth: [ ]
      tags:
        - Account
      parameters:
        - in: path
          name: uuid
          required: true
          schema:
            type: string
          description: The uuid of the compute resource account
        - in: query
          name: organization_id
          schema:
            type: string
          required: true
          description: Node Id of the workspace that we want to enable.
      requestBody:
        description: Workspace enablement configuration
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/workspaceEnablementRequest'
      responses:
        '201':
          description: Successfully enabled workspace for account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/workspaceEnablementResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /accounts/{uuid}/workspaces/{workspaceId}:
    delete:
      summary: Disable a workspace for an account
      description: |
        Disables a workspace for a specific compute resource account
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: deleteAccountWorkspaceEnablement
      security:
        - token_auth: [ ]
      tags:
        - Account
      parameters:
        - in: path
          name: uuid
          required: true
          schema:
            type: string
          description: The uuid of the compute resource account
        - in: path
          name: workspaceId
          required: true
          schema:
            type: string
          description: The workspace ID to disable
      responses:
        '204':
          description: Successfully disabled workspace for account
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /accounts:
    post:
      summary: Registers an external compute resource account
      description: |
        Registers an external compute resource (such as AWS). This method assumes that this account has a role that
        the Pennsieve platform can assume to deploy infrastructure for the compute nodes.
        The Pennsieve Agent handles the creation of this role.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: postAccounts
      security:
        - token_auth: [ ]
      tags:
        - Account
      requestBody:
        description: Payload
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/accountRequest'
      responses:
        '201':
          description: Successfully created compute resource account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/postAccountsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          description: Unprocessable Entity - Account already exists for this user
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "PostAccountsHandler: error records exists"
        '5XX':
          $ref: '#/components/responses/Error'
    get:
      summary: Get account details for the authenticated user
      description: |
        Get account details for compute resources belonging to the authenticated user.
        Optionally filter by workspace or include workspace enablement details.
      parameters:
        - in: query
          name: workspace
          schema:
            type: string
          required: false
          description: Filter accounts by workspace ID (only returns accounts enabled for this workspace)
        - in: query
          name: includeWorkspaces
          schema:
            type: string
            enum: ["true", "false"]
          required: false
          description: Include workspace enablement details in the response
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: getAccounts
      security:
        - token_auth: [ ]
      tags:
        - Account
      responses:
        '200':
          description: The requested compute resource accounts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/accountsGetResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /accounts/{id}:
    get:
      summary: Get account details for a specific compute resource
      description: |
        Get account details for a specific compute resource
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: getAccount
      security:
        - token_auth: [ ]
      tags:
        - Account
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The uuid of the compute resource account
      responses:
        '200':
          description: The requested compute resource account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/accountsGetResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
    patch:
      summary: Update account details
      description: |
        Partially update the status, name, and/or description of a specific compute resource account. Setting the status
        to PAUSED will disable the use of the account for analytic workflows and all compute nodes on this account. This does not affect storage functions.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: patchAccount
      security:
        - token_auth: [ ]
      tags:
        - Account
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The uuid of the compute resource account
      requestBody:
        description: Account update payload
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: ["Enabled", "Paused"]
                  description: The new status for the account
                name:
                  type: string
                  description: The new name for the account
                description:
                  type: string
                  description: The new description for the account
      responses:
        '200':
          description: Successfully updated account status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/accountsGetResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes:
    post:
      summary: Create a new compute node
      description: |
        Creates a new compute node for running analytical workflows. This will provision the necessary
        infrastructure in the specified account including ECS tasks, API Gateway, EFS storage, and SQS queues.
        If organization_id is provided, the node will be created within that workspace context.
        If organization_id is omitted, an organization-independent (private) node will be created.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: postComputeNodes
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: query
          name: organization_id
          schema:
            type: string
          required: false
          description: Node Id of the workspace to create the compute node in. If omitted, creates an organization-independent (private) node.
      requestBody:
        description: Compute node configuration
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/computeNodeRequest'
      responses:
        '201':
          description: Successfully created compute node
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/computeNodeResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
    get:
      summary: List compute nodes
      description: |
        Lists compute nodes accessible to the authenticated user based on access control rules:
        
        **When account_owner=true:**
        - Returns ALL compute nodes on accounts owned by the authenticated user
        - Bypasses individual node permissions and workspace filtering
        - Only works if the user owns at least one compute resource account
        - Useful for billing, management, and auditing purposes
        
        **When no organization_id is provided (normal mode):**
        - Returns only compute nodes owned by the user (organization-independent nodes)
        - These are private nodes created without a workspace context
        
        **When organization_id is provided (normal mode):**
        - Returns nodes accessible to the user within that specific workspace
        - Includes nodes shared with the user directly, through teams, or workspace-wide access
        - Only returns nodes that belong to the specified organization
        
        All responses (except account owner mode) respect the user's actual permissions and access control settings.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: getComputeNodes
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: query
          name: organization_id
          schema:
            type: string
          required: false
          description: |
            Workspace ID to filter nodes by. When provided, returns nodes accessible to the user within that workspace.
            When omitted, returns only user-owned organization-independent (private) nodes.
            Ignored when account_owner=true.
        - in: query
          name: account_owner
          schema:
            type: boolean
          required: false
          description: |
            When set to true, returns ALL compute nodes on accounts owned by the authenticated user,
            regardless of individual node permissions or workspace context. Only works if the user 
            is an account owner. Overrides organization_id filtering when true.
            
            This is useful for account owners who need to see all infrastructure deployed 
            on their accounts for billing, management, or auditing purposes.
      responses:
        '200':
          description: List of compute nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/computeNodeResponse'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}:
    get:
      summary: Get compute node details
      description: |
        Retrieves detailed information about a specific compute node
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: getComputeNode
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
      responses:
        '200':
          description: Compute node details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/computeNodeResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
    put:
      summary: Update compute node configuration
      description: |
        Updates the configuration of an existing compute node, such as workflow manager settings
        or authorization type
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: putComputeNode
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
      requestBody:
        description: Compute node update configuration
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/computeNodeUpdateRequest'
      responses:
        '200':
          description: Successfully updated compute node
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/computeNodeResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
    delete:
      summary: Delete a compute node
      description: |
        Deletes a compute node and all its associated infrastructure. This will terminate running tasks,
        delete the API Gateway, EFS storage, and SQS queues.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: deleteComputeNode
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node to delete
      responses:
        '204':
          description: Successfully deleted compute node
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}/permissions:
    get:
      summary: Get compute node permissions
      description: |
        Retrieves the current permission settings for a compute node. Only accessible by users
        who have access to the node.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: getComputeNodePermissions
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
      responses:
        '200':
          description: Current permission settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/computeNodePermissionsResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
    put:
      summary: Set compute node access scope
      description: |
        Sets the access scope for a compute node. Only the owner of the node can modify the access scope.
        
        Access scope levels:
        - **private**: Only the owner can access the node  
        - **workspace**: All members of the workspace can access the node
        - **shared**: Maintains existing user/team sharing but removes workspace access if any (use POST endpoints to add new shares)
        
        Note: When setting to "shared", existing individual user and team permissions are preserved.
        Use the granular POST/DELETE endpoints on /permissions/users and /permissions/teams to manage specific access grants.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: setComputeNodeAccessScope
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
      requestBody:
        description: Access scope configuration
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/computeNodeAccessScopeRequest'
      responses:
        '200':
          description: Successfully updated access scope
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/computeNodePermissionsResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}/permissions/users:
    post:
      summary: Grant access to a user
      description: |
        Grants access to a specific user for a compute node. Only the owner of the node can grant access.
        This will automatically set the node's access scope to "shared" if it's currently "private" or "workspace".
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: grantUserAccess
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
      requestBody:
        description: User to grant access to
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/grantUserAccessRequest'
      responses:
        '201':
          description: Successfully granted access to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/permissionActionResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}/permissions/users/{userId}:
    delete:
      summary: Revoke access from a user
      description: |
        Revokes access from a specific user for a compute node. Only the owner of the node can revoke access.
        Cannot revoke access from the node owner.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: revokeUserAccess
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
        - in: path
          name: userId
          required: true
          schema:
            type: string
          description: The ID of the user to revoke access from
      responses:
        '200':
          description: Successfully revoked access from user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/permissionActionResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}/permissions/teams:
    post:
      summary: Grant access to a team
      description: |
        Grants access to a specific team for a compute node. Only the owner of the node can grant access.
        This will automatically set the node's access scope to "shared" if it's currently "private" or "workspace".
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: grantTeamAccess
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
      requestBody:
        description: Team to grant access to
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/grantTeamAccessRequest'
      responses:
        '201':
          description: Successfully granted access to team
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/permissionActionResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}/permissions/teams/{teamId}:
    delete:
      summary: Revoke access from a team
      description: |
        Revokes access from a specific team for a compute node. Only the owner of the node can revoke access.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: revokeTeamAccess
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node
        - in: path
          name: teamId
          required: true
          schema:
            type: string
          description: The ID of the team to revoke access from
      responses:
        '200':
          description: Successfully revoked access from team
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/permissionActionResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
  /compute-nodes/{id}/organization:
    post:
      summary: Attach node to organization
      description: |
        Attaches an organization-independent compute node to an organization. 
        The user must have Collaborator or higher access to the target organization.
        Once attached, the node can be shared with other organization members.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: attachNodeToOrganization
      security:
        - token_workspace_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node to attach
        - in: query
          name: organization_id
          required: true
          schema:
            type: string
          description: The organization ID to attach the node to
      responses:
        '200':
          description: Successfully attached node to organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/permissionActionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'
    delete:
      summary: Detach node from organization
      description: |
        Detaches a compute node from its organization, making it organization-independent 
        and private again. Only the account owner can detach nodes. All shared access
        (users, teams, workspace) will be removed, and the node becomes private to the owner.
      x-amazon-apigateway-integration:
        $ref: '#/components/x-amazon-apigateway-integrations/account-service'
      operationId: detachNodeFromOrganization
      security:
        - token_auth: [ ]
      tags:
        - Compute Nodes
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: The UUID of the compute node to detach
      responses:
        '200':
          description: Successfully detached node from organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/permissionActionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '4XX':
          $ref: '#/components/responses/Unauthorized'
        '5XX':
          $ref: '#/components/responses/Error'